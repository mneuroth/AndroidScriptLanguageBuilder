matrix:
  include:    
    - os: linux
      language: android
      compiler: gcc/cmake
      android:
        components:
            - build-tools-26.0.2
            - android-26
      before_install:
        - echo y | sdkmanager "ndk-bundle"
        - echo y | sdkmanager "cmake;3.6.4111459"
        - echo y | sdkmanager "lldb;3.1"
      before_script:
        - export ANDROID_NDK_HOME=$ANDROID_HOME/ndk-bundle
      script:
      - curl -R -O http://www.lua.org/ftp/lua-5.3.5.tar.gz
      - tar zxf lua-5.3.5.tar.gz
      - ls -lrt
      - cd lua-5.3.5
      # disable internal build variables in make file to use externally set environment ariables
      - sed -i 's/CC= gcc -std=gnu99/#CC= i686-linux-android26-clang/g' src/Makefile
      - sed -i 's/PLAT= none/PLAT= posix/g' src/Makefile
      - sed -i 's/AR= ar rcu/#AR= i686-linux-android-ar rcu/g' src/Makefile
      - sed -i 's/RANLIB= ranlib/#RANLIB= i686-linux-android-ranlib/g' src/Makefile
      - sed -i 's/MYCFLAGS=/#MYCFLAGS=/g' src/Makefile
      - sed -i 's/MYLDFLAGS=/#MYLDFLAGS=/g' src/Makefile
      # setup compiler environment for android cross compiler
      - ls -lrt
      - ../build_android_lua.sh "i686-linux-android" "i686-linux-android"
      - make clean
      - ../build_android_lua.sh "x86_64-linux-android" "x86_64-linux-android"
      - make clean
      - ../build_android_lua.sh "armv7a-linux-androideabi" "arm-linux-androideabi"
      - make clean
      - ../build_android_lua.sh "aarch64-linux-android" "aarch64-linux-android"
      - make clean
      - ls -lrt
      #- cat ../build_android_lua.sh
      #- echo $ANDROID_NDK_HOME
      #- ls -lrt $ANDROID_NDK_HOME
      #- ls -lrt $ANDROID_NDK_HOME/toolchains
      #- ls -lrt $ANDROID_NDK_HOME/toolchains/arm-linux-androideabi-4.9
      #- ls -lrt $ANDROID_NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt
      #- ls -lrt $ANDROID_NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64
      #- ls -lrt $ANDROID_NDK_HOME/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin
      #- ls -lrt $ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
      # TODO: zip deployment file
      - pwd
      - export LUA_DEPLOY_ROOT=`pwd`
      deploy:
        provider: releases
        api_key:
          #secure: Ant/0i6hAVbNLNeYMiD0/uqS4HRgdT1b2mVsu8MGppxXGmhAn5Pb+Dv7xRaRiXTuympjI7WHtXDapQsHnMKNWXlv8lizSojVzvzNalh+V8+sn20p7WIXz6QBVy5Fba6CGRm+0EOyYc//leIZMBAENlRXIGKz39ShSl76Z2NwMSRVlLTybnuE716J9xbB/1YzdADE3N4jxF+xd7BnKiPJF9pTQUdgBpFLG9pAVkzKVRsplN+lmysVK1Iwow0z44RqZPSMvFHJLI5IdHgUQ90uDkh5Hnt2WgzonQod3Uy3nKJ3GW58FFoMkzoupA8ySWiJLIfOMNZ47VUE6/6sHRNlpF+g3EEXjKur0HYl488LT0c1yvUtWZUUQeIqW6j5BlCrTCa38Gz1M6I1AH2/NsUeZQ2/4aUAoIpOjyiKOrwdBHKQyPvVlpDxBcpzqRc6a0qlTOkSlWGp83+T7qYatq1pnc56NinUHyePWVheWGQT3WWplaYPflXYMlqNIUmdHz4FUomtFpM8tFzizOhjfLbveF4Od1m0ETLLjIRs1V7IstYW2LXov2yMNSsyAZ3hT2f1K0092U7kfnJisFOClHaA+INZ4KcpXYk0QRqGcBXUR3YN9cfO/qSXUElKmkAnBR3AoJY0CRQ6x7l9NGZi5tVyVKLyxAFyCUcRyZSHL/V3Hck=
          secure: lv82qy0ak6yBSyFOKrPcRSZlLe9jFI5Rixx1yTUtDg3GVwEqrWdqrm+xDhAaa10v1iwHO7BReox9YYFdp4jAkMuvBefKRGJorg1AnhhbOTApqNVtsclXeum428+pv5TXZJaiTyzwPFhZz+OmTAsuC+b1KlWI/fjkaQ44g+QJntlxgW+vExF3VWlcr2d79hEGvgidHlqY9YiRjTAyxIQGP1zOrwDeYlu3seFM0QwL75oLtysPRx8bBWluRyuEFOMfVDjhRTE7TCUlW27GLAnoErpXeBnhHPDEaQoJQlRXp66ArSYYRpGoxmbilSlPYj+bu3pbe3ltN2B8q4QcZpHCxgdOKNRGXWAQYwvANxIFXW4IEBcnqzgvuiq6VXbLdBhQyb2O5XMo0XXv/d695OyNdFu6TcqLa3TFAV1zE4ijmLAt9djzAKnIbMwxq+uaR+ZKU9xMgiABG/YT511Ho5VOHdS+Nx7fjOhfARLVvG54rfSbbl5B+kcW/Qp1lfHy85Eb1axnP9v9uNW3/jBUzoMJewxG4TavlhgVEiYRNgR8mwtwDAyHSJ+Xon1GCSM9J6MDYklQhWc2kx+z1kp75YWrbVhYn9IZK8/+TLhOG6kiGPsZ8MP53GjkQCV4stE4CBxj1YdJZNT9U9x+a9JTqVmhJwsHDMxKaX4uGdMqLaArjJo=
        file: 
          - $LUA_DEPLOY_ROOT/lua-android-i686-linux-android-bin.zip
          - $LUA_DEPLOY_ROOT/lua-android-x86_64-linux-android-bin.zip
          - $LUA_DEPLOY_ROOT/lua-android-armv7a-linux-androideabi-bin.zip
          - $LUA_DEPLOY_ROOT/lua-android-aarch64-linux-android-bin.zip
        skip_cleanup: true
        #on:
        #  tags: true

install:
- "[ $CXX = g++ ] && export CXX=g++-6 || true"
- "[ $CXX = clang++ ] && export CXX=clang++-3.8 || true"
